<?php namespace App\Models; use App\Database\Connection; class AssetIssuance { private $db; public function __construct() { $this->db = Connection::getInstance()->getConnection(); } public function issueAsset($requestId, $assetId, $quantity, $issuedBy) { try { $this->db->beginTransaction(); $asset = $this->getAssetStock($assetId); if (!$asset) { throw new \Exception('Asset not found'); } if ($asset['quantity_onhand'] < $quantity) { throw new \Exception('Insufficient stock. Available: ' . $asset['quantity_onhand']); } $newOnhand = $asset['quantity_onhand'] - $quantity; $this->updateAssetStock($assetId, $newOnhand); $newIssued = $asset['quantity_issued'] + $quantity; $this->updateAssetIssuedQty($assetId, $newIssued); $this->updateRequestStatus($requestId, 'ISSUED'); $this->createIssuanceRecord(['asset_request_id' => $requestId, 'asset_id' => $assetId, 'quantity' => $quantity, 'issued_by' => $issuedBy, 'issued_at' => date('Y-m-d H:i:s'), 'status' => 'ISSUED']); $this->sendIssuanceNotification($requestId, $assetId, $quantity); $this->db->commit(); return ['success' => true, 'message' => "Asset issued successfully. Quantity: $quantity", 'new_stock' => $newOnhand]; } catch (\Exception $e) { $this->db->rollBack(); return ['success' => false, 'error' => $e->getMessage()]; } } public function acceptIssuance($issuanceId, $requestId) { try { $this->db->beginTransaction(); $stmt = $this->db->prepare("UPDATE asset_issuances SET status = ?, accepted_at = GETDATE() WHERE id = ?"); $stmt->execute(['ACCEPTED', $issuanceId]); $this->updateRequestStatus($requestId, 'ACCEPTED'); $this->sendAcceptanceNotification($requestId); $this->db->commit(); return ['success' => true, 'message' => 'Asset issuance accepted successfully']; } catch (\Exception $e) { $this->db->rollBack(); return ['success' => false, 'error' => $e->getMessage()]; } } public function returnAsset($assetId, $quantity, $returnedBy, $reason = null) { try { $this->db->beginTransaction(); $asset = $this->getAssetStock($assetId); if (!$asset) { throw new \Exception('Asset not found'); } if ($asset['quantity_issued'] < $quantity) { throw new \Exception('Cannot return more than issued quantity'); } $newOnhand = $asset['quantity_onhand'] + $quantity; $this->updateAssetStock($assetId, $newOnhand); $newIssued = $asset['quantity_issued'] - $quantity; $this->updateAssetIssuedQty($assetId, $newIssued); $stmt = $this->db->prepare("INSERT INTO asset_returns (asset_id, quantity, returned_by, reason, returned_at) VALUES (?, ?, ?, ?, GETDATE())"); $stmt->execute([$assetId, $quantity, $returnedBy, $reason]); $this->db->commit(); return ['success' => true, 'message' => "Asset returned successfully. New stock: $newOnhand"]; } catch (\Exception $e) { $this->db->rollBack(); return ['success' => false, 'error' => $e->getMessage()]; } } private function getAssetStock($assetId) { $stmt = $this->db->prepare("SELECT id, quantity_onhand, quantity_issued, optimum_stock, max_stock FROM assets WHERE id = ?"); $stmt->execute([$assetId]); return $stmt->fetch(); } private function updateAssetStock($assetId, $quantity) { $stmt = $this->db->prepare("UPDATE assets SET quantity_onhand = ?, updated_at = GETDATE() WHERE id = ?"); return $stmt->execute([$quantity, $assetId]); } private function updateAssetIssuedQty($assetId, $quantity) { $stmt = $this->db->prepare("UPDATE assets SET quantity_issued = ?, updated_at = GETDATE() WHERE id = ?"); return $stmt->execute([$quantity, $assetId]); } private function updateRequestStatus($requestId, $status) { $stmt = $this->db->prepare("UPDATE asset_requests SET status = ?, updated_at = GETDATE() WHERE id = ?"); return $stmt->execute([$status, $requestId]); } private function createIssuanceRecord($data) { $stmt = $this->db->prepare("INSERT INTO asset_issuances (asset_request_id, asset_id, quantity, issued_by, issued_at, status) VALUES (?, ?, ?, ?, ?, ?)"); return $stmt->execute([$data['asset_request_id'], $data['asset_id'], $data['quantity'], $data['issued_by'], $data['issued_at'], $data['status']]); } public function getIssuanceByRequest($requestId) { $stmt = $this->db->prepare("SELECT * FROM asset_issuances WHERE asset_request_id = ? ORDER BY issued_at DESC"); $stmt->execute([$requestId]); return $stmt->fetchAll(); } public function getIssuanceHistory($assetId) { $stmt = $this->db->prepare("SELECT ai.*, u.name as issued_to_name FROM asset_issuances ai LEFT JOIN asset_requests ar ON ai.asset_request_id = ar.id LEFT JOIN users u ON ar.requester_id = u.id WHERE ai.asset_id = ? ORDER BY ai.issued_at DESC"); $stmt->execute([$assetId]); return $stmt->fetchAll(); } private function sendIssuanceNotification($requestId, $assetId, $quantity) { $stmt = $this->db->prepare("SELECT ar.id, ar.requester_id, u.email, u.name, a.name as asset_name FROM asset_requests ar JOIN users u ON ar.requester_id = u.id JOIN assets a ON ar.asset_id = a.id WHERE ar.id = ?"); $stmt->execute([$requestId]); $result = $stmt->fetch(); if ($result) { $message = "Your asset request has been issued! Asset: {
       {$result['asset_name']}, Quantity: $quantity"; $notifStmt = $this->db->prepare("INSERT INTO notifications (user_id, type, message, created_at) VALUES (?, ?, ?, GETDATE())"); $notifStmt->execute([$result['requester_id'], 'ASSET_ISSUED', $message]); } } private function sendAcceptanceNotification($requestId) { $stmt = $this->db->prepare("SELECT ar.id, a.name as asset_name, u.name as requester_name FROM asset_requests ar JOIN assets a ON ar.asset_id = a.id JOIN users u ON ar.requester_id = u.id WHERE ar.id = ?"); $stmt->execute([$requestId]); $result = $stmt->fetch(); if ($result) { $message = "Asset {$result['asset_name']} has been accepted by {$result['requester_name']}"; } } public function checkReorderLevel($assetId) { $stmt = $this->db->prepare("SELECT id, name, quantity_onhand, optimum_stock FROM assets WHERE id = ? AND quantity_onhand < optimum_stock"); $stmt->execute([$assetId]); return $stmt->fetch(); } } ?>